{% extends 'base.html.twig' %}

{% block title %}{% if app.user %}Messager{% else %}Messager - Connexion{% endif %}{% endblock %}

{% block body %}
{% if app.user %}
    <div class="app-wrapper">
        <div class="container">
            <div class="d-flex flex-wrap-reverse justify-content-between align-items-center gap-2 mb-4">
                <h1 class="app-title mb-0">Déclenchements</h1>
                <div class="d-flex gap-2 ms-auto">
                    <a href="{{ path('book_index') }}" class="btn btn-outline-secondary d-inline-flex align-items-center">
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="me-1"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>
                        Gérer les listes
                    </a>
                    <a href="{{ path('trigger_create') }}" class="btn btn-ms-primary">
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="me-1"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
                        Nouveau
                    </a>
                </div>
            </div>

            {% if triggers is empty %}
                <div class="empty-state">
                    <p class="text-muted">Aucun déclenchement pour le moment.</p>
                </div>
            {% else %}
                <div class="trigger-list">
                    {% for trigger in triggers %}
                        {% set counts = statusCounts[trigger.id] ?? {pending: 0, sent: 0, failed: 0, total: 0} %}
                        {% include 'home/_trigger_card.html.twig' with {trigger: trigger, counts: counts} only %}
                    {% endfor %}
                </div>
            {% endif %}
        </div>
    </div>
{% else %}
    <div class="login-wrapper">
        <div class="login-card">
            <div class="logo-section">
                <img src="{{ asset('logo.svg') }}" alt="Messager">
            </div>

            <h1>Connexion</h1>
            <p class="text-center text-muted mb-4">Entrez votre numéro de téléphone</p>

            {% if error is defined and error %}
                <div class="alert alert-danger">{{ error.messageKey|trans(error.messageData, 'security') }}</div>
            {% endif %}

            {{ form_start(form) }}
                <div class="mb-3">
                    <label for="{{ form.phone.vars.id }}" class="form-label visually-hidden">Numéro de téléphone</label>
                    <div class="phone-input-group">
                        <span class="phone-icon">
                            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"/></svg>
                        </span>
                        {{ form_widget(form.phone) }}
                    </div>
                </div>

                <button type="submit" class="btn btn-ms-primary w-100">
                    Continuer
                </button>
            {{ form_end(form) }}

        </div>
    </div>
{% endif %}
{% endblock %}
