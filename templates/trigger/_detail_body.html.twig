{% set has_pending = counts.pending > 0 %}
{% set is_recent = trigger.createdAt|date('U') > 'now'|date('U') - 10800 %}
{% set is_initializing = counts.total == 0 and is_recent %}
{% set should_poll = is_recent and (has_pending or is_initializing) %}

<div id="trigger-detail-body"
    {% if should_poll %}
        data-controller="trigger-status"
        data-trigger-status-url-value="{{ path('trigger_messages', {uuid: trigger.uuid}) }}"
    {% endif %}
>
    {% if is_initializing %}
        <div class="trigger-status-legend mb-3">
            <span class="text-muted"><span class="spinner-border spinner-border-sm me-1" role="status"></span> Préparation des messages…</span>
        </div>
    {% elseif counts.total > 0 %}
        {% set pct_delivered = (counts.delivered / counts.total * 100)|round(1) %}
        {% set pct_sent = (counts.sent / counts.total * 100)|round(1) %}
        {% set pct_failed = (counts.failed / counts.total * 100)|round(1) %}
        {% set pct_pending = (100 - pct_delivered - pct_sent - pct_failed)|round(1) %}

        <div class="progress trigger-progress mb-2" role="progressbar">
            {% if pct_delivered > 0 %}
                <div class="progress-bar bg-success" style="width: {{ pct_delivered }}%"></div>
            {% endif %}
            {% if pct_sent > 0 %}
                <div class="progress-bar bg-primary" style="width: {{ pct_sent }}%"></div>
            {% endif %}
            {% if pct_failed > 0 %}
                <div class="progress-bar bg-danger" style="width: {{ pct_failed }}%"></div>
            {% endif %}
            {% if pct_pending > 0 %}
                <div class="progress-bar bg-secondary" style="width: {{ pct_pending }}%; opacity: 0.3"></div>
            {% endif %}
        </div>

        <div class="trigger-status-legend mb-3">
            {% if pct_delivered > 0 %}
                <span><span class="trigger-status-dot bg-success"></span> {{ pct_delivered }}% distribué{{ pct_delivered > 1 ? 's' : '' }}</span>
            {% endif %}
            {% if pct_sent > 0 %}
                <span><span class="trigger-status-dot bg-primary"></span> {{ pct_sent }}% envoyé{{ pct_sent > 1 ? 's' : '' }}</span>
            {% endif %}
            {% if pct_failed > 0 %}
                <span><span class="trigger-status-dot bg-danger"></span> {{ pct_failed }}% échoué{{ pct_failed > 1 ? 's' : '' }}</span>
            {% endif %}
            {% if pct_pending > 0 %}
                <span><span class="trigger-status-dot bg-secondary"></span> {{ pct_pending }}% en attente</span>
            {% endif %}
        </div>
    {% endif %}

    {% if messages|length > 0 %}
        <div class="table-responsive">
            <table class="table admin-table mb-0">
                <thead>
                    <tr>
                        <th>Contact</th>
                        {% if trigger.type == 'both' %}
                            <th>Type</th>
                        {% endif %}
                        <th>Statut</th>
                        <th>Erreur</th>
                    </tr>
                </thead>
                <tbody>
                    {% for message in messages %}
                        <tr>
                            <td>{{ message.contact.phoneNumber|mask_phone }}</td>
                            {% if trigger.type == 'both' %}
                                <td>
                                    <span class="badge {{ message.type == 'sms' ? 'bg-info' : 'bg-warning text-dark' }} badge-sm">
                                        {{ message.type == 'sms' ? 'SMS' : 'Appel' }}
                                    </span>
                                </td>
                            {% endif %}
                            <td>
                                {% if message.status == 'delivered' %}
                                    <span class="badge bg-success">Distribué</span>
                                {% elseif message.status == 'sent' %}
                                    <span class="badge bg-primary">Envoyé</span>
                                {% elseif message.status == 'failed' %}
                                    <span class="badge bg-danger">Échoué</span>
                                {% else %}
                                    <span class="badge bg-secondary">En attente</span>
                                {% endif %}
                            </td>
                            <td>
                                {% if message.error %}
                                    <span class="text-danger small">{{ message.error }}</span>
                                {% else %}
                                    <span class="text-muted">—</span>
                                {% endif %}
                            </td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    {% endif %}
</div>
