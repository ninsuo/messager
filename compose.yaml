# =============================================================================
# Messager - Docker Compose (common services)
# =============================================================================
#
# This file defines the base services shared across all environments.
# It is NOT meant to be used alone â€” always pair it with an override file.
#
# Development (default):
#   docker compose up -d
#   (automatically loads compose.yaml + compose.override.yaml)
#
# Production:
#   docker compose -f compose.yaml -f compose.prod.yaml up -d
#
# Useful commands:
#   docker compose logs -f          Follow all logs
#   docker compose exec php bash    Shell into the PHP container
#   docker compose down             Stop and remove containers
# =============================================================================

services:

  mysql:
    build:
      context: ./docker/mysql
    user: "999:999"
    environment:
      MYSQL_DATABASE: ${MYSQL_DATABASE:-messager}
      MYSQL_USER: ${MYSQL_USER:-messager}
      MYSQL_PASSWORD: ${MYSQL_PASSWORD}
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD}
    volumes:
      - ./docker/mysql/my.cnf:/etc/my.cnf

  caddy:
    depends_on:
      - php

  php:
    depends_on:
      - mysql
    environment:
      APP_ENV: ${APP_ENV:-prod}

  worker1:
    environment:
      APP_ENV: ${APP_ENV:-prod}

  worker2:
    environment:
      APP_ENV: ${APP_ENV:-prod}

  worker3:
    environment:
      APP_ENV: ${APP_ENV:-prod}

  cron:
    depends_on:
      - mysql
    environment:
      APP_ENV: ${APP_ENV:-prod}
